---
title: "Calculator summary report"
output: html_document
date: "`r Sys.time()`"
params:
  img: PGS_Logo.png
---

```{r setup, include=FALSE}
# sad note: base R + rmarkdown only
# installing the tidyverse is causing me container problems >:(
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval = FALSE, echo=FALSE}
# logo
htmltools::img(src = knitr::image_uri(params$img),
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',
               height = "200px")
```

## Compatibility summary

```{r, echo = FALSE, message = FALSE}
log <- read.csv("log.csv")
log$match_type <- as.character(log$match_type)
log$match_type <- ifelse(log$match_type == "", "no match", log$match_type)
match_count <- setNames(aggregate(chr_name ~ dataset + accession + match_type, length, data = log), c("dataset", "accession", "match_type", "count"))
variant_count <- setNames(aggregate(chr_name ~ dataset + accession, length, data = log),
                          c("dataset", "accession", "total"))

compat <- merge(match_count, variant_count, by = c("dataset", "accession"))
compat$perc <- round(compat$count / compat$total * 100, 1)
compat <- compat[order(compat$count, decreasing = TRUE),] 

knitr::kable(compat, align = c(rep('l', 3), rep('r', 3)))
```

## Score summary

```{r, echo = FALSE, message = FALSE}

read_scorefiles <- function(path) {
  dataset <- strsplit(path, split = "_")[[1]][[1]]
  df <- read.table(path, header = TRUE, comment.char = "")
  cols <- colnames(df) 
  cols[[1]] <- "IID"
  colnames(df) <- cols
  df$dataset <- dataset
  return(df)
}

scorefiles <- list.files(pattern = "*.sscore", all.files = TRUE)
combined_scorefile <- Reduce(rbind, lapply(scorefiles, read_scorefiles))
combined <- aggregate(. ~ dataset + IID, sum, data = combined_scorefile)
write.table(combined, "aggregated_scores.txt", col.names = TRUE, quote = FALSE, row.names = FALSE)
```

Score peek:

```{r, echo = FALSE}
scores <- read.table("aggregated_scores.txt", header = TRUE, comment.char = "")
knitr::kable(head(scores))
xfun::embed_file("aggregated_scores.txt", text = "Download all calculated scores")
```

## Session information

```{r}
sessionInfo()
```
