/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {
    // individual processes ------------------------------------------------------------
    withName: COMBINE_SCOREFILES {
        ext.args = "-v"
    }
    
    withName: PLINK2_VCF {
        ext.args = "--new-id-max-allele-len 100 missing"
    }
    
    withName: PLINK2_RELABELBIM {
        ext.args = "--new-id-max-allele-len 100 missing --allow-extra-chr"
    }

    withName: PLINK2_RELABELPVAR {
        ext.args = "--new-id-max-allele-len 100 missing --allow-extra-chr"
    }

    withName: PLINK2_SCORE {
        ext.args = "--allow-extra-chr"
        ext.args2 = "zs"  // compress .sscore with zstd by default
    }

    // container configuration
    
    withLabel: pgscatalog_utils {
        ext.conda = "$projectDir/environments/pgscatalog_utils/environment.yml"
        ext.docker = 'dockerhub.ebi.ac.uk/gdp-public/pgscatalog_utils/pgscatalog_utils'
        ext.singularity = 'oras://dockerhub.ebi.ac.uk/gdp-public/pgscatalog_utils/singularity/pgscatalog_utils'
        ext.docker_version = ':dev'
        ext.singularity_version = ':dev'
    }

    withLabel: plink2 {
        ext.conda = "bioconda::plink2==2.00a3.3"
        ext.docker = 'ghcr.io/pgscatalog/plink2'
        ext.singularity = 'oras://ghcr.io/pgscatalog/plink2'
        ext.docker_version = ':2.00a3.3'
        ext.singularity_version = ':2.00a3.3-singularity'
    }

    withLabel: zstd {
        ext.conda = "$projectDir/environments/zstd/environment.yml"
        ext.singularity = 'oras://dockerhub.ebi.ac.uk/gdp-public/pgsc_calc/singularity/zstd'
        ext.singularity_version = ':amd64-1.4.8'
        ext.docker = 'dockerhub.ebi.ac.uk/gdp-public/pgsc_calc/zstd'
        ext.docker_version = ':1.4.8'
    }

    withLabel: report {
        ext.conda = "$projectDir/environments/report/environment.yml"
        ext.singularity = 'oras://dockerhub.ebi.ac.uk/gdp-public/pgsc_calc/singularity/report'
        ext.singularity_version = ':2.14'
        ext.docker = 'dockerhub.ebi.ac.uk/gdp-public/pgsc_calc/report'
        ext.docker_version = ':2.14'
    }

    withLabel: pyyaml {
        ext.conda = "conda-forge::pyyaml==6.0"
        ext.singularity = 'oras://ghcr.io/pgscatalog/pyyaml'
        ext.singularity_version = ':6.0-singularity'
        ext.docker = 'ghcr.io/pgscatalog/pyyaml'
        ext.docker_version = ':6.0'
    }

    withLabel: fraposa {
    // TODO: publish fraposa somewhere
//        ext.conda = "$projectDir/environments/report/environment.yml"
        ext.singularity = 'oras://dockerhub.ebi.ac.uk/gdp-public/fraposa_pgsc/singularity/pgsc_fraposa'
        ext.singularity_version = ':dev'
        ext.docker = 'dockerhub.ebi.ac.uk/gdp-public/fraposa_pgsc/pgsc_fraposa'
        ext.docker_version = ':dev'
    }

    // output configuration

    withLabel: copy_genomes {
        publishDir = [
            path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
            mode: 'copy',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]    
    }

    withName: 'PGSCATALOG_GET|SCORE_REPORT|SCORE_AGGREGATE' {
        publishDir = [
            path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
            mode: 'copy'
        ]    
    }

    withName: 'MATCH_VARIANTS|MATCH_COMBINE' {
        publishDir = [
            path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
            pattern: '*.{gz,csv,yml}',
            mode: 'copy'
        ]    
    }
    
    withName: 'ANCESTRY_ANALYSIS' {
        publishDir = [
            path: { "${params.outdir}/work_ancestry" },
            pattern: '*.{txt.gz}',
            mode: 'copy'
        ]    
    }

    withName: 'DUMPSOFTWAREVERSIONS' {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: params.publish_dir_mode,
            pattern: '*_versions.yml'
        ]
    }
}
